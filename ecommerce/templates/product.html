{% extends "base.html" %}
{% load static %}

{% block title %}Products{% endblock title %}

{% block body %}

<section id="portfolio" class="portfolio section">
    <div class="container-fluid mt-4">
        <div class="row">
            <!-- Sidebar Filter -->
            <div class="col-md-3">
                <div class="filter-section sticky-top" style="background-color: #f8f9fa; padding: 20px; border-radius: 10px;">
                    <h4>Filter Products</h4>
                    <form method="get" id="product-filter-form">
                        <div class="mb-3">
                            <input type="text" 
                                  name="search" 
                                  class="form-control" 
                                  placeholder="Search products..." 
                                  value="{{ search_query }}">
                        </div>

                        <div class="mb-3">
                            <label>Categories</label>
                            <select name="category" class="form-control" onchange="this.form.submit()">
                                <option value="">All Categories</option>
                                {% for category in categories %}
                                    <option value="{{ category }}" 
                                        {% if category == selected_category %}selected{% endif %}>
                                        {{ category }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="mb-3">
                            <label>Sort By</label>
                            <select name="sort" class="form-control" onchange="this.form.submit()">
                                <option value="">Default Sorting</option>
                                <option value="price_asc" {% if sort_by == 'price_asc' %}selected{% endif %}>
                                    Price: Low to High
                                </option>
                                <option value="price_desc" {% if sort_by == 'price_desc' %}selected{% endif %}>
                                    Price: High to Low
                                </option>
                                <option value="newest" {% if sort_by == 'newest' %}selected{% endif %}>
                                    Newest Arrivals
                                </option>
                            </select>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Product Grid -->
            <div class="col-md-9">
                {% for product, range, nSlides in allProds %}
                <h3 class="my-3 text-center text-success bg-light">{{ product.0.category }} Collections</h3>

                <div class="container">
                    <div class="row">
                        {% for i in product %}
                        <div class="col-md-3 mt-3">
                            <div class="card">
                                <img src="/media/{{ i.image }}" class="card-img-top mb-3" alt="not found">
                                <div class="card-body">
                                    <h5 class="card-title" id="namepr{{ i.id }}">{{ i.product_name }}</h5>
                                    <p class="card-text">{{ i.desc|slice:":63" }}...</p>
                                    <h6 class="card-title mb-3">Price: $<span id="pricepr{{ i.id }}">{{ i.price }}</span></h6>
                                    <span id="divpr{{ i.id }}" class="divpr">
                                        <button id="pr{{ i.id }}" class="btn btn-danger cart btn-sm mt-0">Add To Cart</button>
                                    </span>
                                    <a href="{% url 'detail-product' product_id=i.id %}">
                                        <button class="btn btn-success btn-sm cart">View</button>
                                    </a>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</section>

<script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js" integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.min.js" integrity="sha384-+sLIOodYLS7CIrQpBjl+C7nPvqq+FbNUBDunl/OZv93DB7Ln/533i8e/mZXLi/P+" crossorigin="anonymous"></script>
<script>
     // Find out the cart from local storage
    if (localStorage.getItem('cart') == null) {
    var cart = {};
} else {
    var cart = JSON.parse(localStorage.getItem('cart'));
    updateCart(cart);
}

// add or increment code
$('.divpr').on('click', 'button.cart', function() {
    var idstr = this.id.toString();
    if (cart[idstr] !== undefined) {
        qty = cart[idstr][0] + 1;
    } else {
        qty = 1;
        name = document.getElementById('namepr' + idstr.slice(2)).innerHTML;
        price = document.getElementById('pricepr' + idstr.slice(2)).innerHTML;
        cart[idstr] = [qty, name, price];
    }
    updateCart(cart);
    localStorage.setItem('cart', JSON.stringify(cart));
    document.getElementById('cart').innerHTML = Object.keys(cart).length;
    console.log(Object.keys(cart).length);
    document.getElementById('popcart').click();
});

$('#popcart').popover();
updatePopover(cart);

function updatePopover(cart) {
    console.log('we are inside update popover');
    var popStr = "<h5>Cart for your items in my shopping cart</h5>";
    var i = 1;
    var totalItems = 0;

    // Cek apakah cart kosong
    if (Object.keys(cart).length === 0) {
        popStr += "<p>Your cart is empty</p>";
    } else {
        for (var item in cart) {
            // Ambil nama produk
            var productName = document.getElementById('namepr' + item.slice(2)).innerHTML.slice(0, 19);
            // Tambahkan item ke popover
            popStr += "<b>" + i + "</b> " + productName + " Qty: " + cart[item][0] + "<br>";
            // Hitung total item
            totalItems += cart[item][0];
            i++;
        }

        // Tambahkan tombol Checkout dan Clear Cart
        popStr += ` 
            <div class="cart-actions mt-2 d-flex justify-content-between"> 
                <a href='/checkout' class='btn btn-success btn-sm'>Checkout</a> 
                <a href='#' id='clearCartBtn' class='btn btn-danger btn-sm'>Clear Cart</a> 
            </div> 
        `;

        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('clearCartBtn').addEventListener('click', function(e) {
                e.preventDefault();
                clearCart();
            });
        });
    }

    // Set konten popover
    document.getElementById('popcart').setAttribute('data-content', popStr);
    // Tampilkan popover
    $('#popcart').popover('show');
    // Klik untuk memastikan popover muncul
    document.getElementById("popcart").click();
}

function clearCart() {
    // Ambil cart dari localStorage
    cart = JSON.parse(localStorage.getItem('cart')) || {};

    // Reset setiap item di cart
    for (var item in cart) {
        let productId = item.slice(2);
        // Reset tombol "Add to Cart"
        let divElement = document.getElementById('divpr' + productId);
        if (divElement) {
            divElement.innerHTML = `<button id="pr${productId}" class="btn btn-danger cart btn-sm mt-0">Add To Cart</button>`;
        }
    }

    // Bersihkan localStorage
    localStorage.removeItem('cart');
    // Reset variabel cart
    cart = {};
    // Update tampilan cart
    updateCart(cart);
    // Refresh popover
    updatePopover(cart);
    // Sembunyikan popover
    $('#popcart').popover('hide');
    // Reset cart badge
    document.getElementById('cart').innerHTML = '0';
}

function updateCart(cart) {
    var sum = 0;
    for (var item in cart) {
        sum = sum + cart[item][0];
        document.getElementById('div' + item).innerHTML = 
            "<button id='minus" + item + "' class='btn btn-success minus'>-</button> " +
            "<span id='val" + item + "'>" + cart[item][0] + "</span> " +
            "<button id='plus" + item + "' class='btn btn-success plus'>+</button>";
    }
    localStorage.setItem('cart', JSON.stringify(cart));
    document.getElementById('cart').innerHTML = sum;
    console.log(cart);
    updatePopover(cart);
    document.getElementById("popcart").click();
}

// Tambahan event handler untuk tombol plus dan minus
$('.divpr').on("click", "button.minus", function() {
    a = this.id.slice(7);
    // Kurangi qty
    cart['pr' + a][0] = cart['pr' + a][0] - 1;
    
    // Jika qty 0, hapus item dari cart
    if (cart['pr' + a][0] <= 0) {
        delete cart['pr' + a];
        // Reset tombol "Add to Cart"
        document.getElementById('divpr' + a).innerHTML = 
            `<button id="pr${a}" class="btn btn-danger cart btn-sm mt-0">Add To Cart</button>`;
    } else {
        // Update qty di cart
        document.getElementById('valpr' + a).innerHTML = cart['pr' + a][0];
    }
    
    // Update cart
    updateCart(cart);
});

$('.divpr').on("click", "button.plus", function() {
    a = this.id.slice(6);
    
    // Jika item belum ada di cart, tambahkan
    if (!cart['pr' + a]) {
        qty = 1;
        name = document.getElementById('namepr' + a).innerHTML;
        price = document.getElementById('pricepr' + a).innerHTML;
        cart['pr' + a] = [qty, name, price];
        
        // Update div dengan tombol + dan qty
        document.getElementById('divpr' + a).innerHTML = 
            `<button id="minus${a}" class="btn btn-success minus">-</button> ` +
            `<span id="valpr${a}">1</span> ` +
            `<button id="plus${a}" class="btn btn-success plus">+</button>`;
    } else {
        // Tambah qty
        cart['pr' + a][0] = cart['pr' + a][0] + 1;
        document.getElementById('valpr' + a).innerHTML = cart['pr' + a][0];
    }
    
    updateCart(cart);
});
</script>
{% endblock %}